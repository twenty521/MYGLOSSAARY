<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EduGlossary Ultimate</title>
    <!-- 加载核心库 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 图标库 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // 初始内置知识库
        const initialData = {
            python: [
                { id: 1, term: 'List Comprehension', chinese: '列表推导式', definition: '一种基于现有列表创建新列表的简洁语法。', example: '[x*2 for x in range(10)]', date: '2023/10/24' },
                { id: 2, term: 'Dictionary', chinese: '字典', definition: '存储键值对的无序集合。', example: 'my_dict = {"name": "Alice"}', date: '2023/10/25' }
            ],
            statistics: [
                { id: 3, term: 'Standard Deviation', chinese: '标准差', definition: '衡量一组数值离散程度的指标。', example: 'σ = sqrt(Σ(x-μ)² / N)', date: '2023/10/26' }
            ],
            grammar: [
                { id: 4, term: 'Passive Voice', chinese: '被动语态', definition: '强调动作的接受者而不是执行者。', example: 'The homework was done by me.', date: '2023/10/26' }
            ]
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('daily');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingId, setEditingId] = useState(null); // 核心：用于追踪当前正在编辑哪一条
            
            // 数据状态
            const [glossary, setGlossary] = useState(() => {
                const saved = localStorage.getItem('edu_glossary_final');
                return saved ? JSON.parse(saved) : initialData;
            });
            const [dailyLogs, setDailyLogs] = useState(() => {
                const saved = localStorage.getItem('edu_logs_final');
                return saved ? JSON.parse(saved) : {};
            });

            // 表单数据
            const [formData, setFormData] = useState({ term: '', chinese: '', definition: '', example: '', image: '' });
            
            // 每日活动数据
            const [newActivity, setNewActivity] = useState({ task: '', focus: 5, mood: 5 });

            // 自动分类逻辑
            useEffect(() => {
                if (editingId) return; // 如果在编辑模式，不要自动跳分类
                const text = formData.term.toLowerCase();
                if (['python', 'list', 'def', 'print', 'import'].some(k => text.includes(k))) setActiveTab('python');
                else if (['mean', 'median', 'test', 'sample', 'probability'].some(k => text.includes(k))) setActiveTab('statistics');
                else if (['verb', 'noun', 'tense', 'clause'].some(k => text.includes(k))) setActiveTab('grammar');
            }, [formData.term]);

            // 持久化保存
            useEffect(() => {
                localStorage.setItem('edu_glossary_final', JSON.stringify(glossary));
                localStorage.setItem('edu_logs_final', JSON.stringify(dailyLogs));
                if (window.lucide) window.lucide.createIcons();
            }, [glossary, dailyLogs, activeTab, isModalOpen]);

            // 图片处理
            const handleImage = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setFormData(prev => ({ ...prev, image: reader.result }));
                    reader.readAsDataURL(file);
                }
            };

            // 核心：保存/更新逻辑
            const handleSave = (e) => {
                e.preventDefault();
                const todayStr = new Date().toLocaleDateString(); // 获取今天的日期

                if (editingId) {
                    // --- 编辑模式 ---
                    // 找到原来的那一条，替换成新的内容，但保留原来的 ID 和日期（或者你可以选择更新日期）
                    const updatedList = glossary[activeTab].map(item => 
                        item.id === editingId ? { ...formData, id: editingId, date: item.date } : item
                    );
                    setGlossary({ ...glossary, [activeTab]: updatedList });
                } else {
                    // --- 新增模式 ---
                    const newItem = { ...formData, id: Date.now(), date: todayStr };
                    setGlossary({ ...glossary, [activeTab]: [newItem, ...glossary[activeTab]] });
                }
                closeModal();
            };

            // 打开编辑窗口
            const openEdit = (item) => {
                setFormData(item);      // 把要修改的内容填入表单
                setEditingId(item.id);  // 标记当前正在编辑的 ID
                setIsModalOpen(true);   // 打开弹窗
            };

            const closeModal = () => {
                setIsModalOpen(false);
                setEditingId(null);
                setFormData({ term: '', chinese: '', definition: '', example: '', image: '' });
            };

            // 每日记录逻辑
            const saveActivity = () => {
                if (!newActivity.task) return;
                const key = new Date().toISOString().split('T')[0];
                const current = dailyLogs[key] || { activities: [], score: 0 };
                const updatedActs = [...current.activities, { 
                    ...newActivity, 
                    id: Date.now(), 
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) 
                }];
                // 计算分数
                const avgF = updatedActs.reduce((a,c) => a + Number(c.focus), 0) / updatedActs.length;
                const avgM = updatedActs.reduce((a,c) => a + Number(c.mood), 0) / updatedActs.length;
                const score = Math.round((avgF * 0.7 + avgM * 0.3) * 10);
                
                setDailyLogs({ ...dailyLogs, [key]: { activities: updatedActs, score } });
                setNewActivity({ task: '', focus: 5, mood: 5 });
            };

            const todayKey = new Date().toISOString().split('T')[0];
            const todayData = dailyLogs[todayKey] || { activities: [], score: 0 };

            return (
                <div className="min-h-screen flex flex-col max-w-md mx-auto bg-slate-50 pb-24">
                    {/* 顶部导航 */}
                    <header className="bg-slate-900 text-white p-6 rounded-b-[2.5rem] shadow-xl sticky top-0 z-30">
                        <div className="flex justify-between items-center mb-4">
                            <div>
                                <h1 className="text-xl font-black">EduGlossary <span className="text-indigo-400 italic">Pro</span></h1>
                                <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">学习追踪与复习助手</p>
                            </div>
                            <button onClick={() => setIsModalOpen(true)} className="bg-indigo-600 p-3 rounded-2xl shadow-lg active:scale-90 transition-transform">
                                <i data-lucide="plus" className="w-5 h-5"></i>
                            </button>
                        </div>
                    </header>

                    {/* 分类切换 */}
                    <nav className="flex justify-around p-4 bg-white/80 backdrop-blur-md border-b sticky top-[88px] z-20">
                        {[
                            {id: 'python', icon: 'code'}, {id: 'statistics', icon: 'bar-chart-2'},
                            {id: 'grammar', icon: 'pen-tool'}, {id: 'daily', icon: 'activity'}
                        ].map(t => (
                            <button key={t.id} onClick={() => setActiveTab(t.id)} className={`p-3 rounded-2xl transition-all ${activeTab === t.id ? 'bg-indigo-600 text-white shadow-lg scale-110' : 'text-slate-300'}`}>
                                <i data-lucide={t.icon} className="w-5 h-5"></i>
                            </button>
                        ))}
                    </nav>

                    {/* 主内容区 */}
                    <main className="p-4 space-y-6">
                        {activeTab === 'daily' ? (
                            <div className="space-y-6">
                                {/* 仪表盘 */}
                                <div className="bg-indigo-600 p-6 rounded-[2.5rem] text-white shadow-xl flex justify-between items-center">
                                    <div>
                                        <div className="text-[10px] font-bold opacity-60 uppercase">今日状态分</div>
                                        <div className="text-6xl font-black">{todayData.score}</div>
                                    </div>
                                    <div className="h-16 flex items-end gap-1 px-3 py-2 bg-white/10 rounded-2xl">
                                        {todayData.activities.map((a, i) => (
                                            <div key={i} className="w-1.5 bg-white rounded-t-full transition-all duration-500" style={{height: `${a.focus * 10}%`}}></div>
                                        ))}
                                    </div>
                                </div>

                                {/* 输入状态 */}
                                <div className="bg-white p-5 rounded-[2.5rem] shadow-sm space-y-4">
                                    <input className="w-full p-4 bg-slate-50 rounded-2xl outline-none text-sm" placeholder="刚才做了什么？" value={newActivity.task} onChange={e => setNewActivity({...newActivity, task: e.target.value})} />
                                    <div className="flex gap-4">
                                        <div className="flex-grow space-y-1"><div className="text-[10px] font-bold">专注 {newActivity.focus}</div><input type="range" min="1" max="10" className="w-full accent-indigo-600" value={newActivity.focus} onChange={e => setNewActivity({...newActivity, focus: e.target.value})} /></div>
                                        <div className="flex-grow space-y-1"><div className="text-[10px] font-bold">心情 {newActivity.mood}</div><input type="range" min="1" max="10" className="w-full accent-pink-500" value={newActivity.mood} onChange={e => setNewActivity({...newActivity, mood: e.target.value})} /></div>
                                    </div>
                                    <button onClick={saveActivity} className="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-xs uppercase">记录状态</button>
                                </div>
                                
                                {/* 时间轴 */}
                                <div className="space-y-3">
                                    {todayData.activities.slice().reverse().map(act => (
                                        <div key={act.id} className="bg-white p-4 rounded-3xl flex items-center justify-between shadow-sm">
                                            <div className="flex items-center gap-3">
                                                <span className="text-[10px] font-bold text-slate-300">{act.time}</span>
                                                <span className="text-sm font-bold text-slate-700">{act.task}</span>
                                            </div>
                                            <div className="flex gap-1 text-[9px] font-bold">
                                                <span className="bg-indigo-50 text-indigo-500 px-2 py-1 rounded-lg">F:{act.focus}</span>
                                                <span className="bg-pink-50 text-pink-500 px-2 py-1 rounded-lg">M:{act.mood}</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {glossary[activeTab].length === 0 && <div className="text-center py-20 text-slate-300 text-xs">暂无笔记，点击右上角添加</div>}
                                {glossary[activeTab].map(item => (
                                    <div key={item.id} className="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100 relative group">
                                        
                                        {/* 顶部信息栏：日期 + 操作按钮 */}
                                        <div className="flex justify-between items-start mb-2">
                                            <div className="space-y-1">
                                                <h3 className="text-lg font-black text-slate-800 leading-tight">{item.term}</h3>
                                                <div className="flex items-center gap-1 text-[10px] font-bold text-slate-300 bg-slate-50 px-2 py-1 rounded-full w-fit">
                                                    <i data-lucide="calendar" className="w-3 h-3"></i> 
                                                    {item.date || '未知日期'}
                                                </div>
                                            </div>
                                            <div className="flex gap-1">
                                                {/* 编辑按钮：核心功能 */}
                                                <button onClick={() => openEdit(item)} className="p-2 bg-indigo-50 text-indigo-600 rounded-full hover:bg-indigo-100 transition-colors">
                                                    <i data-lucide="edit-3" className="w-4 h-4"></i>
                                                </button>
                                                {/* 删除按钮 */}
                                                <button onClick={() => {
                                                    if(confirm('确认删除吗？')) setGlossary({...glossary, [activeTab]: glossary[activeTab].filter(i => i.id !== item.id)})
                                                }} className="p-2 bg-slate-50 text-slate-300 rounded-full hover:bg-rose-50 hover:text-rose-500 transition-colors">
                                                    <i data-lucide="trash-2" className="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <div className="text-indigo-600 font-bold text-xs mb-4 italic pl-1 border-l-2 border-indigo-200">{item.chinese}</div>
                                        
                                        {item.image && <img src={item.image} className="rounded-2xl mb-4 w-full border border-slate-100" />}
                                        
                                        <div className="space-y-3">
                                            <p className="text-xs text-slate-600 leading-relaxed bg-slate-50/50 p-3 rounded-xl">{item.definition}</p>
                                            {item.example && (
                                                <div className="bg-slate-900 p-4 rounded-2xl relative overflow-hidden">
                                                    <div className="absolute top-0 right-0 p-2 opacity-10"><i data-lucide="code" className="w-12 h-12 text-white"></i></div>
                                                    <code className="text-indigo-300 text-[10px] font-mono block whitespace-pre-wrap relative z-10">{item.example}</code>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {/* 添加/编辑 弹窗 */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 bg-slate-900/20 backdrop-blur-sm flex items-end sm:items-center justify-center">
                            <div className="bg-white w-full max-w-md h-[90vh] sm:h-[80vh] rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 flex flex-col slide-up shadow-2xl">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-black text-slate-800">
                                        {editingId ? '编辑笔记' : '新记录'}
                                    </h2>
                                    <button onClick={closeModal} className="p-3 bg-slate-100 rounded-full text-slate-500 hover:rotate-90 transition-transform">
                                        <i data-lucide="x" className="w-6 h-6"></i>
                                    </button>
                                </div>
                                
                                <form onSubmit={handleSave} className="space-y-4 overflow-y-auto no-scrollbar pb-10">
                                    <div className="bg-indigo-50 p-3 rounded-2xl text-[10px] text-indigo-600 font-bold flex items-center gap-2">
                                        <i data-lucide="zap" className="w-3.5 h-3.5"></i>
                                        {editingId ? "正在修改原有记录" : `将自动存入 ${activeTab.toUpperCase()} 分类`}
                                    </div>

                                    <div className="space-y-1">
                                        <label className="text-[10px] font-bold text-slate-400 uppercase ml-2">术语 (Term)</label>
                                        <input required className="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-slate-800 focus:ring-2 focus:ring-indigo-100 transition-all" value={formData.term} onChange={e => setFormData({...formData, term: e.target.value})} placeholder="例如: DataFrame" />
                                    </div>

                                    <div className="space-y-1">
                                        <label className="text-[10px] font-bold text-slate-400 uppercase ml-2">中文含义</label>
                                        <input className="w-full p-4 bg-slate-50 rounded-2xl outline-none text-sm focus:ring-2 focus:ring-indigo-100 transition-all" value={formData.chinese} onChange={e => setFormData({...formData, chinese: e.target.value})} placeholder="例如: 数据框" />
                                    </div>

                                    <label className="block w-full p-6 border-2 border-dashed border-slate-200 rounded-[2rem] text-center cursor-pointer hover:bg-slate-50 transition-colors group">
                                        <i data-lucide="image" className="mx-auto mb-2 text-slate-300 group-hover:text-indigo-400 transition-colors"></i>
                                        <span className="text-xs font-bold text-slate-400 block">{formData.image ? "点击更换图片" : "上传板书/截图"}</span>
                                        <input type="file" className="hidden" accept="image/*" onChange={handleImage} />
                                    </label>
                                    {formData.image && <img src={formData.image} className="h-24 w-auto rounded-xl mx-auto shadow-md border border-slate-100" />}

                                    <div className="space-y-1">
                                        <label className="text-[10px] font-bold text-slate-400 uppercase ml-2">详细定义</label>
                                        <textarea className="w-full p-4 bg-slate-50 rounded-2xl h-24 outline-none text-sm focus:ring-2 focus:ring-indigo-100 transition-all" value={formData.definition} onChange={e => setFormData({...formData, definition: e.target.value})} placeholder="解释这个概念..." />
                                    </div>

                                    <div className="space-y-1">
                                        <label className="text-[10px] font-bold text-slate-400 uppercase ml-2">示例 / 代码</label>
                                        <textarea className="w-full p-4 bg-slate-50 rounded-2xl h-24 outline-none font-mono text-xs focus:ring-2 focus:ring-indigo-100 transition-all" value={formData.example} onChange={e => setFormData({...formData, example: e.target.value})} placeholder="import pandas as pd..." />
                                    </div>

                                    <button type="submit" className="w-full bg-slate-900 text-white py-5 rounded-[2rem] font-black text-lg shadow-xl shadow-slate-200 active:scale-95 transition-transform">
                                        {editingId ? '保存修改' : '确认添加'}
                                    </button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
